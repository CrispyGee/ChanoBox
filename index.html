<!DOCTYPE html>
<html lang="de" style="height :100%;">
<head>
<meta charset="utf-8"/>

  <!-- Bootstrap core CSS -->
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap theme -->
  <link href="bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">

  <!-- Bootstrap core JavaScript -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script>
    window.jQuery || document.write('<script src="jquery.min.js"><\/script>')
  </script>
  <script src="bootstrap/js/bootstrap.min.js"></script>

  <script src="resumable.js"></script>
  <script>
    var filesToUpload = [];
    var fileListJSON;
    var r = new Resumable({
      target: 'chunkUpload.php'
    });
    function upload() {
      console.log("uploading", filesToUpload);
      console.log("uploading resumable", r.files);

      if(filesToUpload.length > 0){
        r.upload();
        filesToUpload = [];
      }
    }
    function loadResumable() {

      // delete r;

      r = new Resumable({
        target: 'chunkUpload.php'
      });

      r.assignBrowse(document.getElementById('browseButton'));
      r.assignDrop(document.getElementById('dropTarget'));
      

      r.on('fileSuccess', function (file) {
        console.log('fileSuccess', file);
      });
      r.on('fileProgress', function (file) {
        console.log('fileProgress', file);
      });
      r.on('fileAdded', function (file, event) {

        var upload = cancelResumableFile(file);
        console.log('current files to upload', r.files);
        if(!upload){
          return;
        }

        // console.log("adding file: " + file + " ...");

        var fileList = document.getElementById("file-list");

        // var drop_list = $("#dropTarget");
        // var file_size_mb = (file.size / 1000000.0).toFixed(2);
        // drop_list.append(file.fileName + " " + file_size_mb + "mb<br>");
        var file_size_kb = (file.size / 1024.0).toFixed(2);
        var file_size_mb = (file_size_kb / 1024.0).toFixed(2);
        var file_size_gb = (file_size_gb / 1024.0).toFixed(2);

        var fileSimple = {name: file.fileName, size: file_size_mb + "M"};
        var list_entry = createListEntry(fileSimple);
        // var delete_button = list_entry.listChild;
        // delete_button.style.hide();
        fileList.appendChild(list_entry);

        console.log('fileAdded', event);
      });
      r.on('filesAdded', function (array) {
        console.log('filesAdded event starts', array);
        for (var file of array) {
          var upload = cancelResumableFile(file);
          if(upload){
            console.log("upload true.. add to local list");
            filesToUpload.push(file.fileName);
          }
        }
        console.log('current files to upload', r.files);
      });
      r.on('fileRetry', function (file) {
        console.log('fileRetry', file);
      });
      r.on('fileError', function (file, message) {
        console.log('fileError', file, message);
      });
      r.on('uploadStart', function () {
        console.log('uploadStart');
      });
      r.on('complete', function () {
        refreshFileList();
        // clearUploadBox();

        // reset total-progress-bar //
        $('#total-progress-bar').css('width', '0%');
        $('#total-progress-bar').css('aria-valuenow', 0);

        // loadResumable();

        // location.reload();  // TEMP!!!

        console.log('complete');
      });
      r.on('progress', function () {
        var total_progress = parseInt(r.progress() * 100.0, 10);
        // console.log('progress', total_progress + '%');
        $('#total-progress-bar').css('width', total_progress + '%');
        $('#total-progress-bar').css('aria-valuenow', total_progress);
      });
      r.on('error', function (message, file) {
        console.log('error', message, file);
      });
      r.on('pause', function () {
        console.log('pause');
      });
      r.on('cancel', function () {
        console.log('cancel');
      });
    }

    function cancelResumableFile(file){
      var upload = true;
      for(var oldFile of fileListJSON){
        if(oldFile.name == file.fileName) {
          console.log("FILE " + file.fileName + " already exists. ABORT");
          upload = false;
          var indexToRemove = -1;
          for(var i = 0; i < r.files.length; i++) {
            if(r.files[i].fileName == file.fileName) {
              indexToRemove = i;
              break;
            }
          }
          console.log('files before remove', r.files);
          r.files.splice(i, 1);
          console.log('files after remove', r.files);
        }
      }
      return upload;
    }

    function createListEntry(file){
      var list_entry = document.createElement("li");
      list_entry.className = "list-group-item";

      var over_container = document.createElement("div");
      over_container.style.display = "inline";


      // -------- file-name link -------- //
      var li_content = file.name;
      var filename_link = document.createElement('a');
      filename_link.className = "btn-link";
      filename_link.appendChild(document.createTextNode(li_content));
      filename_link.style = " cursor: pointer";
      // filename_link.style.display = "block";
      addDownloadFunction(filename_link, file);
      over_container.appendChild(filename_link);


      // -------- file-size badge -------- //
      var filesize_badge = document.createElement('span');
      filesize_badge.textContent = file.size + "";
      filesize_badge.className = 'badge';
      filesize_badge.style.cssFloat = "right";
      


      // -------- delete button -------- //
      var delete_button = document.createElement('div');
      delete_button.className = "glyphicon glyphicon-trash";
      delete_button.style = "float:right; padding-left:10px; padding-right:10px; cursor: pointer;";
      // filesize_badge.style.cssFloat = "right";
      addDeleteFunction(delete_button, file);
      over_container.appendChild(delete_button);
      over_container.appendChild(filesize_badge);

      

      // -------- progress bar -------- //
      var file_prog_cont = document.createElement("div");
      file_prog_cont.className = "progress";
      // file_prog_cont.style.width = "100px";
      // file_prog_cont.style.maxWidth = "100px";
      var file_prog_bar = document.createElement("div");
      file_prog_bar.className = "progress-bar";
      file_prog_cont.appendChild(file_prog_bar);
      // file_prog_bar.setAttribute("role", "progressbar");
      // file_prog_bar.style.role = "progressbar";
      file_prog_bar.setAttribute("aria-valuemin", "0");
      file_prog_bar.setAttribute("aria-valuemax", "100");
      file_prog_bar.setAttribute("aria-valuenow", "0");
      file_prog_bar.style.width = "0%";
      // over_container.appendChild(file_prog_cont);



      list_entry.appendChild(over_container);

      return list_entry;
    }

    function refreshFileList() {
      //var fileListRef = document.getElementById("fileList");
      var fileListNewRef = document.getElementById("file-list");
      // remove current List (except for header) //


      while(fileListNewRef.childNodes.length > 2){
        fileListNewRef.removeChild(fileListNewRef.lastChild);
      }


      // fill new list //
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          fileListJSON = JSON.parse(this.responseText);
          // list header //
          // var list_header = document.createElement("lh");
          // list_header.textContent = "Dateien";
          // list_header.classname = "list-group-item";
          // fileListNewRef.appendChild(list_header);

          // list entries
          for (const file of fileListJSON) {
            var list_entry = createListEntry(file);
            fileListNewRef.appendChild(list_entry);
          }
        }
      };
      xmlhttp.open("GET", "getFileList.php", true);
      xmlhttp.send();
    }
    function addDeleteFunction(element, file) {
      element.addEventListener("click", function () {
        console.log("delete", file.name);
        deleteFile(file.name);
      });
    }
    function addDownloadFunction(element, file) {
      element.addEventListener('click', function () {
        var xmlhttpDL = new XMLHttpRequest();
        xmlhttpDL.onload = function (e) {
          var blob = new Blob([this.response], { type: 'file' });
          let a = document.createElement("a");
          a.style = "display: none";
          document.body.appendChild(a);
          let url = window.URL.createObjectURL(blob);
          a.href = url;
          a.download = file.name;
          a.click();
          window.URL.revokeObjectURL(url);
        };
        xmlhttpDL.open("POST", "downloadFile.php", true);
        xmlhttpDL.responseType = 'blob';
        xmlhttpDL.send(file.name);
      }, false);
    }
    function deleteFile(filename) {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          refreshFileList();
        }
      };
      xmlhttp.open("POST", "deleteFile.php", true);
      xmlhttp.send(filename);
    }
   
  </script>
</head>

<body style="min-height: 100%;" onload="loadResumable(); refreshFileList();">

  <div id="dropTarget" class="container" style="height:100%;">
    <!-- ======== Page-Header-Bar ======== -->
    <div class="container">
      <nav class="navbar navbar-inverse navbar-fixed-top">
      </nav>
    </div>
  
  
    <!-- ======== Page-Header-Text ======== -->
    <div class="container" style="padding-top:20px;">
        <h1 class="page-header">Interner File-Server</h1>
    </div>

    <div id="content-container" class="container">
      <!-- ======== File-List ======== -->
      <div id="list-container">
        <!-- looks better with -->
        <!-- list -->
        <ul id="file-list" class="list-group">
          <lh name="file-list-header" class="list-group-item">
            <b>
              Dateinamen
              <button onclick="refreshFileList()" class="btn btn-sm btn-default" style="float:right; padding-top:3px;">
                <div class="glyphicon glyphicon-refresh"></div>
              </button>
              <span style="float:right; padding-right:5px;">Groesse</span>
            </b>
          </lh>
          <!-- <li class="list-group-item">File 1 <span class="badge">12mb</span></li> -->
          <!-- <li class="list-group-item">File 2 <span class="badge"> 5mb</span></li> -->
          <!-- <li class="list-group-item">File 3 <span class="badge"> 3mb</span></li> -->
        </ul>
      </div>
      <!-- ======== Drag-Drop ======== -->
      <!-- <div id="dragdrop-container"> -->
        <!-- <div id="lelnope" style="border: 5px dashed #aaa; padding: 10px;"> -->
          <!-- <h3 style="margin: 0px; margin-bottom: 20px; color: #aaa;">Hier hochzuladende Dateien reinziehen</h3> -->
        <!-- </div> -->
      <!-- </div> -->
      <!-- ======== Buttons ======== -->
      <div id="button-container" style="padding-top: 10px;">
        <button onclick="" id="browseButton" class="btn btn-lg btn-default">
          <div class="glyphicon glyphicon-option-horizontal" style="padding-right:10px;"></div>Select files
        </button>
        <button onclick="upload()" class="btn btn-lg btn-default">
          <div class="glyphicon glyphicon-upload" style="padding-right:10px;"></div>Start Upload
        </button>
      </div>
    </div><!-- /layout-container -->
  
    <!-- Progress-Bar  -->
    <div id="progress-bar" class="container">
      <h2>Uploading progress</h2>
      <div class="progress">
        <div id="total-progress-bar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
          style="width:0%">
        </div>
      </div>
    </div>

  </div><!-- /container -->

</body>

</html>
